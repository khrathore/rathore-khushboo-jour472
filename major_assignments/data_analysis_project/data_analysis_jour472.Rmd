---
title: "Data Analysis Project"
author: "Caroline Koutsos, Khushboo Rathore"
date: "04 April 2023"
  html_document:
    theme: cerulean
    highlight: pygments
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

Loading required libraries for this analysis.

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(janitor)
library(dplyr)
library(ggplot2)
```

## Load and Cleaning Data

```{r}
### LOAD AND CLEAN DATA ###

wsoccer_matchstat_2020 <- read_csv("data/ncaa_womens_soccer_matchstats_2020.csv", guess_max = 5000)
wsoccer_matchstat_2021 <- read_csv("data/ncaa_womens_soccer_matchstats_2021.csv", guess_max = 5000)
wsoccer_matchstat_2022 <- read_csv("data/ncaa_womens_soccer_matchstats_2022.csv", guess_max = 5000)

wsoccer_playerstat_2020 <- read_csv("data/ncaa_womens_soccer_playerstats_2020.csv", guess_max = 5000)
wsoccer_playerstat_2021 <- read_csv("data/ncaa_womens_soccer_playerstats_2021.csv", guess_max = 5000)
wsoccer_playerstat_2022 <- read_csv("data/ncaa_womens_soccer_playerstats_2022.csv", guess_max = 5000)

wsoccer_teams_2020 <- read_csv("url_csvs/NCAA Women's Soccer - 2020.csv") %>% 
  clean_names()
wsoccer_teams_2021 <- read_csv("url_csvs/NCAA Women's Soccer - 2021.csv") %>% 
  clean_names()
wsoccer_teams_2022 <- read_csv("url_csvs/NCAA Women's Soccer - 2022.csv") %>% 
  clean_names()

col_names <- colnames(wsoccer_matchstat_2020)
# Data Dictionary: https://docs.google.com/spreadsheets/d/1lnEauTJ62LcCfWJdwIHUitD6Hai_-1YCDVsEbwiTSG8/edit#gid=0

match_20 <- wsoccer_matchstat_2020 %>% 
  mutate(season = 2020) %>% 
  select(-points, -na.x, -na.y, -defensive_points)

match_21 <- wsoccer_matchstat_2021 %>% 
  mutate(season = 2021) %>% 
  select(-gwg, -defensive_gwg)

match_22 <- wsoccer_matchstat_2022 %>% 
  mutate(season = 2022) %>% 
  select(-gwg, -defensive_gwg)
  

match_all <- match_20 %>% 
  rbind(match_21, match_22)

teams_21 <- wsoccer_teams_2021 %>% 
  select(-so_g, -gwg, -games)

teams_22 <- wsoccer_teams_2022 %>% 
  select(-so_g, -gwg, -games)

cols_20 <- names(wsoccer_teams_2020)

teams_20 <- wsoccer_teams_2020 %>% 
  select(url, institution, conference, goals, assists, -points, sh_att, fouls, red_cards, yellow_cards, gc, goal_app, ggs, goalie_min_plyd, ga, saves, shutouts, combined_sho, g_wins, g_loss, d_saves, corners, pk, pk_att)

players_20 <- wsoccer_playerstat_2020 %>% 
  select(season, team, jersey, full_name, roster_name, first_name, last_name, yr, pos, gp, gs, goals, assists, points, sh_att, fouls, red_cards, yellow_cards, gc, goal_app, ggs, goalie_min_plyd, ga, gaa, saves, sv_pct, combined_sho, shutouts, g_wins, g_loss, d_saves, corners, pk, pk_att, gwg)

players_21 <- wsoccer_playerstat_2021 %>% 
  select(-so_g, -games)

players_22 <- wsoccer_playerstat_2022 %>% 
  select(-so_g, -games)

players_all <- players_20 %>% 
  rbind(players_21, players_22)

all_teams <- teams_20 %>% 
 rbind(teams_21, teams_22)
```

# Questions
1. General comparison of performance at Home vs Away games:
  Do teams get more shutouts at Home games?
  Do players get carded more at Away games?
  Does being at a new field impact wins and losses aka W/L ratios?
  
``` {r}
matches_wld <- match_all %>% 
  group_by(team, home_away, outcome) %>% 
  count() %>% 
  pivot_wider(names_from = outcome, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  mutate(wld_ratio = paste0(Win, "-", Loss, "-",Draw)) %>% 
  mutate(win_percent = Win/(Win+Loss+Draw)*100)

matches_compares <- match_all %>% 
  mutate(outcome = case_when(
    str_detect(outcome,"Loss")~0,
    str_detect(outcome,"Win")~1,
    str_detect(outcome,"Draw")~.5,
    TRUE~NA
  )) %>% 
  group_by(team, home_away) %>% 
  summarize(
    w_l_d = mean(outcome),
    shutouts = sum(shutouts),
    all_red = sum(red_cards),
    all_yellow = sum(yellow_cards),
    foul_mean = mean(fouls),
    foul_median = median(fouls),
    score_mean = mean(team_score),
    score_med = median(team_score),
    goal_rate = sum(goals)/sum(sh_att),
  ) %>% 
  left_join(matches_wld, by = c("team", "home_away"))


```
2. Do more popular numbers (attacking players) (10, 11, 9, 7) equate to more goals scored per season (group player performances across seasons and divide by # seasons played) ?

```{r}
player_filter <- players_all %>% 
  filter(jersey == 10| jersey == 11| jersey == 9| jersey == 7| jersey == 23) %>% 
  select(-full_name, -points, -red_cards:-corners)

player_anti <- players_all %>% 
  filter(!(jersey == 10| jersey == 11| jersey == 9| jersey == 7| jersey == 23)) %>% 
  select(-full_name, -points, -red_cards:-corners)

jersey_players <- player_filter %>% 
  # Asked Chat GPT: "How do I replace the NA values in every numeric column in a R dataframe with 0?"
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  group_by(jersey) %>%
  summarize(
    mean_gp = mean(gp),
    mean_goals = mean(goals),
    median_goals = median(goals),
    goal_shtrat = sum(goals)/sum(sh_att)*100,
    mean_fouls = mean(fouls),
    pk_success = sum(pk)/sum(pk_att)*100,
    gwg = mean(gwg)
  )

other_players <- player_anti %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  group_by(jersey) %>%
  summarize(
    mean_gp = mean(gp),
    mean_goals = mean(goals),
    median_goals = median(goals),
    goal_shtrat = sum(goals)/sum(sh_att)*100,
    mean_fouls = mean(fouls),
    pk_success = sum(pk)/sum(pk_att)*100,
    gwg = mean(gwg)
  )

player_by_jersey <- jersey_players %>% 
  rbind(other_players) %>% 
  ggplot(aes(x = mean_goals, y = goal_shtrat,label = jersey)) +
  geom_point(size = 2, shape = 1, color = "black") + 
  labs(
    title = "Higher Jersey Numbers Are More of a Threat Near Goal",
    x = "Mean Goals",
    y = "Percent of Shots Made"
  ) +
  geom_text(check_overlap = TRUE)


player_by_jersey
```

3. Upperclassmen vs Underclassmen: what years typically dominate the starting lineup in different conferences

```{r}
# Need: number games played per season, number of games each player started during that season over the number of games the team played. Conference information, year information.

games_per_team <- match_all %>% 
  group_by(season, team) %>% 
  count()

team_unique <- all_teams %>%
  group_by(institution, conference) %>% 
  summarize(
    avg_goals = round(mean(goals),2),
    avg_shutouts = round(mean(shutouts),2),
    avg_fouls = round(mean(fouls),2)
  ) %>% 
  distinct(institution, .keep_all = TRUE)

regex_unis <- regex(paste(unique(all_teams$institution), collapse = "|"))

player_team <- players_all %>% 
  mutate(institution = str_extract(team, regex_unis)) %>% 
  mutate(institution = case_when(
    str_detect(team, "LMU \\(CA\\)")~"LMU (CA)",
    str_detect(team, "Miami \\(FL\\)")~"Miami (FL)",
    str_detect(team, "Miami \\(OH\\)")~"Miami (OH)",
    str_detect(team, "Queens \\(NC\\)")~"Queens (NC)",
    str_detect(team, "Saint Francis \\(PA\\)")~"Saint Francis (PA)",
    str_detect(team, "Saint Mary's \\(CA\\)")~"Saint Mary's (CA)",
    str_detect(team, "St. John's \\(NY\\)")~"St. John's (NY)",
    str_detect(team, "St. Thomas \\(MN\\)")~"St. Thomas (MN)",
    str_detect(team, "FDU")~"Fairleigh Dickinson",
    TRUE~institution
  )) %>% 
  select(season:gs, institution, -gp, -pos, -full_name) %>%
  left_join(games_per_team, by = c("season", "team")) %>% 
  left_join(team_unique, by = "institution") %>% 
  rename(season_games = n)


player_by_year <- player_team %>% 
  group_by(roster_name, institution, yr, conference, season) %>% 
  summarize(
    percent_start = round(gs/season_games*100,2)
  ) %>% 
  mutate(percent_start = case_when(
    is.na(percent_start)~0,
    TRUE~percent_start
  ))
  
institution_year <- player_team %>%
  group_by(roster_name, institution, yr, conference, season) %>% 
  summarize(
    percent_start = round(gs/season_games*100,2)
  ) %>% 
  mutate(percent_start = case_when(
    is.na(percent_start)~0,
    TRUE~percent_start
  )) %>% 
  group_by(institution, conference, yr) %>% 
  summarize(
    starter = mean(percent_start)
  ) %>% 
  pivot_wider(names_from = "yr", values_from = "starter") %>% 
  select(institution, conference, Fr, So, Jr, Sr) %>% 
  left_join(team_unique, by = c("institution", "conference"))


conference_stats <- institution_year %>% 
  group_by(conference) %>% 
  summarize(
    fr = round(mean(Fr),2),
    so = round(mean(So),2),
    jr = round(mean(Jr),2),
    sr = round(mean(Sr),2),
    mean_goals = round(mean(avg_goals),2),
    mean_sos = round(mean(avg_shutouts),2),
    mean_foul = round(mean(avg_fouls),2)
  )

```

4. Team with the most shutouts vs team with most goals scored: which team is more successful on avg? Does the offense or defense performance impact match result more?
5. Success rate of different types of mascots: (animals, mythical creatures, humans, etc.)?

```{r}
team_mascot <- unique(match_all$team)
team_list <- unique(all_teams$institution)


```


## Caveats and Limitations:
- Some statistics in 2020 are not present in 2021 and 2022, and vice versa
- We do not have data about the teams as a whole (i.e. what division they are in, what conference they are in)
- 2020 had only some conferences playing matches since it was during COVID, also fewer players so some may have redshirted, opted-out, etc.
- Matches are not classified at playoff games or normal games, so we would need to check the dates.
- No game count or shots on goal data for 2020 players, not sure if this was a scrape problem or something else.


