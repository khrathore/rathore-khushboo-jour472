---
title: "Data Analysis Project"
author: "Caroline Koutsos, Khushboo Rathore"
date: "28 April 2023"
  html_document:
    theme: cerulean
    highlight: pygments
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

Loading required libraries for this analysis.

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(janitor)
library(dplyr)
library(ggplot2)
```

## Load and Cleaning Data

```{r}
### LOAD AND CLEAN DATA ###

wsoccer_matchstat_2020 <- read_csv("data/ncaa_womens_soccer_matchstats_2020.csv", guess_max = 5000)
wsoccer_matchstat_2021 <- read_csv("data/ncaa_womens_soccer_matchstats_2021.csv", guess_max = 5000)
wsoccer_matchstat_2022 <- read_csv("data/ncaa_womens_soccer_matchstats_2022.csv", guess_max = 5000)

wsoccer_playerstat_2020 <- read_csv("data/ncaa_womens_soccer_playerstats_2020.csv", guess_max = 5000)
wsoccer_playerstat_2021 <- read_csv("data/ncaa_womens_soccer_playerstats_2021.csv", guess_max = 5000)
wsoccer_playerstat_2022 <- read_csv("data/ncaa_womens_soccer_playerstats_2022.csv", guess_max = 5000)

wsoccer_teams_2020 <- read_csv("url_csvs/NCAA Women's Soccer - 2020.csv") %>% 
  clean_names()
wsoccer_teams_2021 <- read_csv("url_csvs/NCAA Women's Soccer - 2021.csv") %>% 
  clean_names()
wsoccer_teams_2022 <- read_csv("url_csvs/NCAA Women's Soccer - 2022.csv") %>% 
  clean_names()

# Find the column names, create a key
col_names <- colnames(wsoccer_matchstat_2020)
# Data Dictionary: https://docs.google.com/spreadsheets/d/1lnEauTJ62LcCfWJdwIHUitD6Hai_-1YCDVsEbwiTSG8/edit#gid=0

# Clean 2020 match data so that we can rbind()
match_20 <- wsoccer_matchstat_2020 %>% 
  mutate(season = 2020) %>% 
  select(-points, -na.x, -na.y, -defensive_points)

# Clean 2021 match data so that we can rbind()
match_21 <- wsoccer_matchstat_2021 %>% 
  mutate(season = 2021) %>% 
  select(-gwg, -defensive_gwg)

# Clean 2022 match data so that we can rbind()
match_22 <- wsoccer_matchstat_2022 %>% 
  mutate(season = 2022) %>% 
  select(-gwg, -defensive_gwg)
  
# All matches across all three seasons
match_all <- match_20 %>% 
  rbind(match_21, match_22)

# Clean 2021 team data so that we can rbind()
teams_21 <- wsoccer_teams_2021 %>% 
  select(-so_g, -gwg, -games)

# Clean 2022 team data so that we can rbind()
teams_22 <- wsoccer_teams_2022 %>% 
  select(-so_g, -gwg, -games)

# Clean 2020 team data so that we can rbind()
cols_20 <- names(wsoccer_teams_2020)

teams_20 <- wsoccer_teams_2020 %>% 
  select(url, institution, conference, goals, assists, -points, sh_att, fouls, red_cards, yellow_cards, gc, goal_app, ggs, goalie_min_plyd, ga, saves, shutouts, combined_sho, g_wins, g_loss, d_saves, corners, pk, pk_att)

# Clean 2020 player data so that we can rbind()
players_20 <- wsoccer_playerstat_2020 %>% 
  select(season, team, jersey, full_name, roster_name, first_name, last_name, yr, pos, gp, gs, goals, assists, points, sh_att, fouls, red_cards, yellow_cards, gc, goal_app, ggs, goalie_min_plyd, ga, gaa, saves, sv_pct, combined_sho, shutouts, g_wins, g_loss, d_saves, corners, pk, pk_att, gwg)

# Clean 2021 player data so that we can rbind()
players_21 <- wsoccer_playerstat_2021 %>% 
  select(-so_g, -games)

# Clean 2022 player data so that we can rbind()
players_22 <- wsoccer_playerstat_2022 %>% 
  select(-so_g, -games)

# All players across three seasons
players_all <- players_20 %>% 
  rbind(players_21, players_22)

# All teams across three seasons
all_teams <- teams_20 %>% 
 rbind(teams_21, teams_22)
```

# Question One:
General comparison of performance at Home vs Away games:
  Do teams get more shutouts at Home games?
  Do players get carded more at Away games?
  Does being at a foreign field impact wins and losses aka W/L ratios?

# Answer:

Our analysis seems to indicate that teams have a significant advantage at home games. There was a significant difference in win percent, shutouts, and yellow cards for each team between home and away games. However, there was not a significant difference in the number of fouls usually given in home vs away games. It would be interesting to continue this by looking at difference in referees and if there tend to be stricter refs in certain conferences or at certain universities which could contribute to the cards. It would also be interesting to look at home and away with the additional context of a different field surface (actual grass vs turf, etc.)

``` {r}
matches_wld <- match_all %>% 
  # Group games by home/away and win-loss-draw for each team
  group_by(team, home_away, outcome) %>% 
  count() %>% 
  pivot_wider(names_from = outcome, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  # Create a column that has the Win-Loss-Draw ratio for the teams across all seasons
  mutate(wld_ratio = paste0(Win, "-", Loss, "-",Draw)) %>% 
  # Create a column that shows the win percentage for home vs away games across all seasons
  mutate(win_percent = Win/(Win+Loss+Draw)*100)

matches_compares <- match_all %>% 
  # Assign a numeric value to each outcome
  mutate(outcome = case_when(
    str_detect(outcome,"Loss")~0,
    str_detect(outcome,"Win")~1,
    str_detect(outcome,"Draw")~.5,
    TRUE~NA
  )) %>% 
  group_by(team, home_away) %>% 
  # Create summary statistics for a variety of 
  summarize(
    w_l_d = mean(outcome),
    shutouts = sum(shutouts),
    all_red = sum(red_cards),
    all_yellow = sum(yellow_cards),
    foul_mean = mean(fouls),
    foul_median = median(fouls),
    score_mean = mean(team_score),
    score_med = median(team_score),
    goal_rate = sum(goals)/sum(sh_att),
  ) %>% 
  left_join(matches_wld, by = c("team", "home_away"))

# Boxplots that show wins, yellow cards, and mean of fouls 
boxplot(matches_compares$win_percent ~ matches_compares$home_away)
boxplot(matches_compares$all_yellow ~ matches_compares$home_away)
boxplot(matches_compares$foul_mean ~ matches_compares$home_away)



# Separate dataframes into data by home and away games
teams_home <- matches_compares %>% 
  filter(home_away == "Home")

teams_away <- matches_compares %>% 
  filter(home_away == "Away")

# T-Test to see home and away differences.
t.test(teams_home$win_percent, teams_away$win_percent, paired=TRUE)
t.test(teams_home$shutouts, teams_away$shutouts, paired=TRUE)
t.test(teams_home$all_yellow, teams_away$all_yellow, paired=TRUE)
t.test(teams_home$foul_mean, teams_away$foul_mean, paired=TRUE)

```
2. Do more popular numbers (attacking players) (10, 11, 9, 7) equate to more goals scored per season (group player performances across seasons and divide by # seasons played) ?

```{r}

# Specifically collect statistics for any players who have jersey numbers 10, 11, 9, 7, and 23.
player_filter <- players_all %>% 
  filter(jersey == 10| jersey == 11| jersey == 9| jersey == 7| jersey == 23) %>% 
  select(-full_name, -points, -red_cards:-corners)

# Look at the statistics for players outside of those jersey numbers
player_anti <- players_all %>% 
  filter(!(jersey == 10| jersey == 11| jersey == 9| jersey == 7| jersey == 23)) %>% 
  select(-full_name, -points, -red_cards:-corners)

# Get some statistics for each jersey number we like
jersey_players <- player_filter %>% 
  # Asked Chat GPT: "How do I replace the NA values in every numeric column in a R dataframe with 0?"
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  group_by(jersey) %>%
  summarize(
    mean_gp = mean(gp),
    mean_goals = mean(goals),
    median_goals = median(goals),
    goal_shtrat = sum(goals)/sum(sh_att)*100,
    mean_fouls = mean(fouls),
    pk_success = sum(pk)/sum(pk_att)*100,
    gwg = mean(gwg)
  )

# Get statistics for all other jersey numbers
other_players <- player_anti %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0)) %>% 
  group_by(jersey) %>%
  summarize(
    mean_gp = mean(gp),
    mean_goals = mean(goals),
    median_goals = median(goals),
    goal_shtrat = sum(goals)/sum(sh_att)*100,
    mean_fouls = mean(fouls),
    pk_success = sum(pk)/sum(pk_att)*100,
    gwg = mean(gwg)
  )

# Create a chart that shows which 
player_by_jersey <- jersey_players %>% 
  rbind(other_players) %>% 
  ggplot(aes(x = mean_goals, y = goal_shtrat,label = jersey)) +
  geom_point(size = 2, shape = 1, color = "black") + 
  labs(
    title = "Higher Jersey Numbers Are More of a Threat Near Goal",
    x = "Mean Goals",
    y = "Percent of Shots Made"
  ) +
  geom_text(check_overlap = TRUE)


player_by_jersey
```

3. Upperclassmen vs Underclassmen: what years typically dominate the starting lineup in different conferences

```{r}
# Need: number games played per season, number of games each player started during that season over the number of games the team played. Conference information, year information.

games_per_team <- match_all %>% 
  group_by(season, team) %>% 
  count()

team_unique <- all_teams %>%
  group_by(institution, conference) %>% 
  summarize(
    avg_goals = round(mean(goals),2),
    avg_shutouts = round(mean(shutouts),2),
    avg_fouls = round(mean(fouls),2)
  ) %>% 
  distinct(institution, .keep_all = TRUE)

regex_unis <- regex(paste(unique(all_teams$institution), collapse = "|"))

player_team <- players_all %>% 
  mutate(institution = str_extract(team, regex_unis)) %>% 
  mutate(institution = case_when(
    str_detect(team, "LMU \\(CA\\)")~"LMU (CA)",
    str_detect(team, "Miami \\(FL\\)")~"Miami (FL)",
    str_detect(team, "Miami \\(OH\\)")~"Miami (OH)",
    str_detect(team, "Queens \\(NC\\)")~"Queens (NC)",
    str_detect(team, "Saint Francis \\(PA\\)")~"Saint Francis (PA)",
    str_detect(team, "Saint Mary's \\(CA\\)")~"Saint Mary's (CA)",
    str_detect(team, "St. John's \\(NY\\)")~"St. John's (NY)",
    str_detect(team, "St. Thomas \\(MN\\)")~"St. Thomas (MN)",
    str_detect(team, "FDU")~"Fairleigh Dickinson",
    TRUE~institution
  )) %>% 
  select(season:gs, institution, -gp, -pos, -full_name) %>%
  left_join(games_per_team, by = c("season", "team")) %>% 
  left_join(team_unique, by = "institution") %>% 
  rename(season_games = n)


player_by_year <- player_team %>% 
  group_by(roster_name, institution, yr, conference, season) %>% 
  summarize(
    percent_start = round(gs/season_games*100,2)
  ) %>% 
  mutate(percent_start = case_when(
    is.na(percent_start)~0,
    TRUE~percent_start
  ))
  
institution_year <- player_team %>%
  group_by(roster_name, institution, yr, conference, season) %>% 
  summarize(
    percent_start = round(gs/season_games*100,2)
  ) %>% 
  mutate(percent_start = case_when(
    is.na(percent_start)~0,
    TRUE~percent_start
  )) %>% 
  group_by(institution, conference, yr) %>% 
  summarize(
    starter = mean(percent_start)
  ) %>% 
  pivot_wider(names_from = "yr", values_from = "starter") %>% 
  select(institution, conference, Fr, So, Jr, Sr) %>% 
  left_join(team_unique, by = c("institution", "conference"))


conference_stats <- institution_year %>% 
  group_by(conference) %>% 
  summarize(
    fr = round(mean(Fr),2),
    so = round(mean(So),2),
    jr = round(mean(Jr),2),
    sr = round(mean(Sr),2),
    mean_goals = round(mean(avg_goals),2),
    mean_sos = round(mean(avg_shutouts),2),
    mean_foul = round(mean(avg_fouls),2)
  )

```

4. Team with the most shutouts vs team with most goals scored: which team is more successful on avg? Does the strength of an offense or defense impact match result more?

```{r}
team_wld <- match_all %>% 
  # Group games by home/away and win-loss-draw for each team
  group_by(team, outcome) %>% 
  count() %>% 
  pivot_wider(names_from = outcome, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  # Create a column that has the Win-Loss-Draw ratio for the teams across all seasons
  mutate(wld_ratio = paste0(Win, "-", Loss, "-",Draw)) %>% 
  # Create a column that shows the win percentage for home vs away games across all seasons
  mutate(win_percent = Win/(Win+Loss+Draw)*100)

matches_od <- match_all %>%
  group_by(team) %>% 
  summarize(
    tot_shut = sum(shutouts),
    avg_shut = mean(shutouts),
    tot_goals = sum(goals),
    avg_goals = mean(goals)
  ) %>% 
  left_join(team_wld, by = "team")

hist(matches_od$win_percent ~ matches_od$avg_goals)
  
top_shut <- matches_od %>% 
  arrange(desc(avg_shut)) %>% 
  head(100)
  
top_goals <- matches_od %>% 
  arrange(desc(avg_goals)) %>% 
  head(100)

boxplot(top_shut$win_percent)
boxplot(top_goals$win_percent)

# team_goals <- team_unique %>%
  
```


5. Success rate of different types of mascots: (animals, mythical creatures, humans, etc.)?

ANIMAL: (golden, purple, screaming) eagles, (runnin', lady) bulldogs, wildcats, falcons, zips, (lady) hornets, (lady) tigers, (lady) panthers, (lady) lions, razorbacks, cougars, cardinals, bruins, broncos, terriers, bison(s), bulls, roadrunners, mustangs, lancers, camels, mocs, chanticleers, buffaloes, rams, bluejays, (blue) hens, hornets, stags, owls, gators, hoya*, lopes (antelopes), Rainbow Wahine, (christian) huskies, (lady) jaguars, bengals, redbirds, Hoosiers, gaels, dolphins,	Gamecocks, JMU dukes, kangaroos, Roos, sharks, golden flashes, LMU (CA) Lions, leopards, greyhounds, Red Foxes, Thundering Herd, Terrapins (terps), golden gophers, (golden) grizzlies, lobos, aggies, tar heels, ospreys, bobcats, sooners, monarchs, mavericks, ducks, beavers, nittany lions, Mastodons, spiders, broncs, Peacocks, jackrabbits, coyotes, Salukis, Bonnies, tommies, horned frogs, longhorns, anteaters, retrievers, utes, beacons, catamounts, hokies, leathernecks, badgers, great danes, penguins

MYTHICAL: (sun, blue) devils, titans, (golden) griffins, (blue, lady) demons, demon deacons, dragons, phoenix, devilettes, Billikens, blazers, tritons

PEOPLE: governors, (lady) braves, mountaineers, (black, FDU, Scarlet) knights, matadors, chippewas, buccaneers, 49ers, vikings, (blue, red) raiders, flyers, pioneers, duquesne dukes*, (lady) pirates, islanders, colonels, seminoles, paladins, colonials, crusaders, vandals, explorers, trojans, Lady Techsters, jaspers, minutewomen, cowgirls, warriors, spartans, racers, highlanders, midshipmen, cornhuskers, huskers, lumberjacks, norse, fighting irish, (lady) rebels, quakers, pilots, friars, boilermakers, royals, Ladyjacks, Aztecs, Toreros, Dons, Saints, Hatters, Texas, Volunteers, cadets, gauchos, miners, vaqueros, trailblazers, VMI cadets, commodores, cavaliers, musketeers

NATURE: crimson tide, cyclones, Sycamores, (lady) flame, beach, hurricanes, buckeyes, waves, red storm, orange, golden hurricane, flames

MISC: big red, big green, purple aces, crimson, pride, Fighting Illini, Ragin' Cajuns, Ramblers, mean green, blue hose, the Red Flash, rockets, lady topper, tribe


```{r}
team_sums <- all_teams %>%
  group_by(institution, conference) %>% 
  summarize(
    tot_goals = sum(goals),
    tot_shutouts = sum(shutouts),
    tot_fouls = sum(fouls)
  ) %>% 
  distinct(institution, .keep_all = TRUE)

regex_unis <- regex(paste(unique(all_teams$institution), collapse = "|"))
regex_peoplemascot <- regex("governors|braves|mountaineers|duke|knights|matadors|chippewas|buccaneers|49ers|vikings|raiders|flyers|pioneers|pirates|islanders|colonels|seminoles|paladins|colonials|crusaders|vandals|explorers|trojans|techsters|jaspers|minutewomen|cowgirls|warriors|spartans|racers|highlanders|midshipmen|cornhuskers|huskers|lumberjacks|norse|irish|rebels|quakers|pilots|friars|boilermakers|royals|ladyjacks|aztecs|toreros|dons|saints|hatters|texas|volunteers|cadets|gauchos|miners|vaqueros|trailblazers|cadets|commodores|cavaliers|musketeers|lancer|gael|beacon")

mascot_list <- match_all %>% 
  mutate(institution = str_extract(team, regex_unis)) %>% 
  ## Asked CHATGPT: "How do I extract everything after a certain pattern in R?"
  mutate(mascot = str_squish(sub(regex_unis, "", team))) %>% 
  mutate(institution = case_when(
    str_detect(team, "LMU \\(CA\\)")~"LMU (CA)",
    str_detect(team, "Miami \\(FL\\)")~"Miami (FL)",
    str_detect(team, "Miami \\(OH\\)")~"Miami (OH)",
    str_detect(team, "Queens \\(NC\\)")~"Queens (NC)",
    str_detect(team, "Saint Francis \\(PA\\)")~"Saint Francis (PA)",
    str_detect(team, "Saint Mary's \\(CA\\)")~"Saint Mary's (CA)",
    str_detect(team, "St. John's \\(NY\\)")~"St. John's (NY)",
    str_detect(team, "St. Thomas \\(MN\\)")~"St. Thomas (MN)",
    str_detect(team, "FDU")~"Fairleigh Dickinson",
    TRUE~institution
  )) %>% 
  group_by(team, mascot, institution) %>% 
  summarize(
    tot_yc = sum(yellow_cards)
  ) %>% 
  inner_join(team_sums, by = "institution") %>% 
  mutate(mas_category = case_when(
    str_detect(str_to_lower(mascot), "devil|titan|griffin|demon|dragon|phoenix|billiken|blazer|triton")~"mythical",
    str_detect(str_to_lower(mascot), regex_peoplemascot)~"people",
    str_detect(str_to_lower(institution), "vmi")~"people",
    str_detect(str_to_lower(mascot), "tide|cyclones|sycamores|flame|beach|hurricane|buckeyes|waves|storm|orange")~"nature",
    str_detect(str_to_lower(mascot), "big red|big green|purple aces|crimson|pride|illini|cajuns|ramblers|mean green|blue hose|red flash|rockets|lady topper|tribe")~"miscellaneous",
    TRUE~"animal"
  )) %>% 
  replace(is.na(.), 0) 

by_mascot <- mascot_list %>% 
  group_by(mas_category) %>% 
  summarize(
    mean_fouls = mean(tot_fouls),
    med_fouls = median(tot_fouls),
    mean_goals = mean(tot_goals),
    med_goals = median(tot_goals),
    med_shut = median(tot_shutouts)
  )

boxplot(mascot_list$tot_goals ~ mascot_list$mas_category)
boxplot(mascot_list$tot_shutouts ~ mascot_list$mas_category)

```

## Caveats and Limitations:
- Some statistics in 2020 are not present in 2021 and 2022, and vice versa
- We do not have data about the teams as a whole (i.e. what division they are in, what conference they are in)
- 2020 had only some conferences playing matches since it was during COVID, also fewer players so some may have redshirted, opted-out, etc.
- Matches are not classified at playoff games or normal games, so we would need to check the dates.
- No game count or shots on goal data for 2020 players, not sure if this was a scrape problem or something else.


